# Multi-stage Docker container for E2E testing
FROM node:24.5.0-alpine AS base

# Install system dependencies
RUN apk add --no-cache \
    chromium \
    chromium-chromedriver \
    git \
    dumb-init \
    curl \
    bash

# Set environment variables
ENV CHROME_BIN=/usr/bin/chromium-browser
ENV CHROME_PATH=/usr/bin/chromium-browser
ENV CHROMEDRIVER_PATH=/usr/bin/chromedriver

# Create app directory
WORKDIR /app

# Copy package files first for better caching
COPY package*.json ./

# Install dependencies (including devDependencies for Angular dev server)
RUN npm ci --include=dev

# Copy source code
COPY . .

# Build shared library
RUN npx ng build --project=shared

# Create directories for logs and results
RUN mkdir -p logs/metrics allure-results

# Set default port for Angular dev server
ENV PORT=4200
EXPOSE 4200

# Use dumb-init to handle signals properly
ENTRYPOINT ["dumb-init", "--"]

# Default command runs the sharded E2E tests
CMD ["npm", "run", "test:e2e:docker"]