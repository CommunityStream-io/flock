# Use our custom base image with Node.js and Chrome pre-installed
# This will be much faster than installing everything from scratch
# Replace 'your-dockerhub-username' with your actual Docker Hub username
FROM your-dockerhub-username/flock-base:latest

# Set working directory
WORKDIR /app

# Accept build argument for package token
ARG PACKAGE_TOKEN
ENV PACKAGE_TOKEN=$PACKAGE_TOKEN

# Copy entire codebase first
COPY . .

# Install all dependencies (including devDependencies for Angular dev server)
RUN npm ci --no-audit --no-fund --legacy-peer-deps

# Build the shared library (required for the app)
RUN npm run build:shared

# Create directories for logs and results
RUN mkdir -p logs/metrics logs/servers logs/shards logs/exits logs/drivers allure-results

# Set environment variables for testing
ENV NODE_ENV=test
ENV HEADLESS=true
ENV CI=true
ENV TIMEOUT_TELEMETRY=true

# Expose port for Angular dev server
EXPOSE 4200