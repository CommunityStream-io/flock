version: '3.8'

services:
  electron-builder:
    build:
      context: ..
      dockerfile: docker/Dockerfile.electron-build
      args:
        # Pass GitHub package token from host environment
        PACKAGE_TOKEN: ${PACKAGE_TOKEN}
        NATIVE_SENTRY_DSN: ${NATIVE_SENTRY_DSN}
        NATIVE_SENTRY_DSN_MAIN: ${NATIVE_SENTRY_DSN_MAIN}
        SENTRY_AUTH_TOKEN: ${SENTRY_AUTH_TOKEN}
        SENTRY_ORG: ${SENTRY_ORG}
    container_name: flock-electron-builder
    volumes:
      # Mount output directory to host
      - ../dist/electron:/app/dist/electron
      # Mount node_modules for faster rebuilds (optional)
      - electron-node-modules:/app/node_modules
    environment:
      # Electron builder configuration
      - CI=true
      - DEBUG=electron-builder
      # Prevent Electron from downloading on every build
      - ELECTRON_CACHE=/app/.electron-cache
      # Pass GitHub package token
      - PACKAGE_TOKEN=${PACKAGE_TOKEN}
      # Pass Sentry variables
      - NATIVE_SENTRY_DSN=${NATIVE_SENTRY_DSN}
      - NATIVE_SENTRY_DSN_MAIN=${NATIVE_SENTRY_DSN_MAIN}
      - SENTRY_AUTH_TOKEN=${SENTRY_AUTH_TOKEN}
      - SENTRY_ORG=${SENTRY_ORG}
    command: >
      sh -c "
        echo 'ğŸ³ Starting Electron Windows build in Docker with Wine...' &&
        echo 'ğŸ“¦ Cleaning old build artifacts...' &&
        rm -rf /app/dist/electron/* &&
        echo 'ğŸ“¦ Installing dependencies inside container (npm ci)...' &&
        npm ci &&
        echo 'ğŸ”¨ Building Electron app with NSIS installer...' &&
        xvfb-run npx electron-builder --win --publish never --config.directories.output=/app/dist/electron &&
        echo 'âœ… Build complete! Check dist/electron/' &&
        ls -la /app/dist/electron/
      "
    networks:
      - electron-build-network

volumes:
  electron-node-modules:
    driver: local

networks:
  electron-build-network:
    driver: bridge

