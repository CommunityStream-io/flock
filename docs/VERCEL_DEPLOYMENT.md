# Flock Murmur - Vercel Deployment Guide

## üåä Overview

Flock Murmur is now deployable to Vercel as a hybrid client-server application. The Angular SPA runs on the client while serverless edge functions handle Instagram archive processing and Bluesky migration.

## üèóÔ∏è Architecture

### Client (Angular SPA)
- File upload interface
- Configuration management
- Progress tracking
- Results display

### Server (Vercel Edge Functions)
- `/api/upload` - Handle archive uploads (max 500MB)
- `/api/migrate` - Process migration with rate limiting
- `/api/progress` - Track migration progress

### Storage (Vercel KV)
- Upload metadata and file data
- Migration progress tracking
- Session management

## üöÄ Deployment

### Prerequisites
1. Vercel account
2. GitHub repository connected to Vercel
3. Vercel KV database configured

### Environment Variables

Configure these in your Vercel project settings:

```bash
# Bluesky API (required)
BLUESKY_API_URL=https://bsky.social/xrpc

# Vercel KV (auto-configured by Vercel)
VERCEL_KV_REST_API_URL=<auto-generated>
VERCEL_KV_REST_API_TOKEN=<auto-generated>

# Node environment
NODE_ENV=production
```

### Deploy Steps

1. **Install Vercel CLI** (optional, for local testing)
   ```bash
   npm install -g vercel
   ```

2. **Link to Vercel Project**
   ```bash
   vercel link
   ```

3. **Deploy**
   ```bash
   vercel --prod
   ```

   Or push to your main branch if connected to GitHub.

### Automatic Deployments

When connected to GitHub, Vercel automatically:
- Deploys preview builds for pull requests
- Deploys production builds for the main branch

## üìù Configuration

### vercel.json

The `vercel.json` file configures:
- Build command: `npm run build:murmur`
- Output directory: `dist/flock-murmur/browser`
- API routes and their resource limits
- Environment variables

### Function Limits

| Function | Max Duration | Memory | Notes |
|----------|--------------|--------|-------|
| `/api/upload` | 300s (5 min) | 1024MB | |
| `/api/migrate` | 300s (5 min) | 2048MB | ‚ö†Ô∏è Free tier limits. Upgrade to Pro for 900s/3008MB |
| `/api/progress` | 30s | 512MB | |

**‚ö†Ô∏è Important:** The migration function is limited by Vercel's free tier (Hobby plan):
- **Duration:** 300 seconds (5 minutes) - may timeout for large archives
- **Memory:** 2048MB - may run out of memory for very large archives with many media files

To handle larger migrations:
- Upgrade to Vercel Pro plan (allows up to 900s duration and 3008MB memory)
- Or use the native desktop app (Flock Native) for unlimited processing

## üîß Local Development

### Run Locally with Vercel CLI

```bash
# Install dependencies
npm install --legacy-peer-deps

# Build the Angular app
npm run build:murmur

# Run Vercel dev server
vercel dev
```

This starts:
- Angular app at `http://localhost:3000`
- API functions at `http://localhost:3000/api/*`
- Local Vercel KV emulation

### Run Angular Dev Server Only

```bash
ng serve flock-murmur
```

This runs only the client without API functions.

## üìä Monitoring

### Vercel Dashboard
- Function execution logs
- Performance metrics
- Error tracking
- KV storage usage

### Logs

View function logs in Vercel dashboard or via CLI:
```bash
vercel logs <deployment-url>
```

## üêõ Troubleshooting

### Upload Fails
- Check file size (max 500MB)
- Verify KV storage quota
- Check function timeout settings

### Migration Fails
- Verify Bluesky credentials
- Check API rate limits
- Review function logs for errors

### Build Fails
- Ensure all dependencies are installed
- Check TypeScript compilation errors
- Verify angular.json configuration

## üîí Security

### API Security
- CORS enabled for client requests
- Session-based access control
- Automatic session expiration (1-2 hours)

### Data Privacy
- Files stored temporarily in KV
- Automatic cleanup after expiration
- No long-term data retention

## üìö API Documentation

### POST /api/upload

Upload Instagram archive.

**Request:**
- Content-Type: `multipart/form-data`
- Field: `archive` (ZIP file, max 500MB)

**Response:**
```json
{
  "success": true,
  "sessionId": "upload_1234567890_abc123",
  "filename": "instagram-data.zip",
  "size": 12345678,
  "message": "File uploaded successfully"
}
```

### POST /api/migrate

Start migration process.

**Request:**
```json
{
  "sessionId": "upload_1234567890_abc123",
  "config": {
    "blueskyCredentials": {
      "username": "user.bsky.social",
      "password": "app-password"
    },
    "simulate": false,
    "startDate": "2023-01-01",
    "endDate": "2024-12-31"
  }
}
```

**Response:**
```json
{
  "success": true,
  "results": {
    "postsImported": 42,
    "postsFailed": 0,
    "mediaCount": 156,
    "duration": "125.3s",
    "sessionId": "upload_1234567890_abc123"
  }
}
```

### GET /api/progress

Get migration progress.

**Request:**
- Query: `?sessionId=upload_1234567890_abc123`

**Response:**
```json
{
  "success": true,
  "progress": {
    "status": "processing",
    "phase": "migration",
    "message": "Migrating post 25 of 50...",
    "percentage": 65,
    "currentPost": 25,
    "totalPosts": 50,
    "updatedAt": "2024-01-15T12:34:56.789Z"
  }
}
```

## üéØ Best Practices

1. **File Size Management**
   - Compress archives before upload
   - Split very large archives if needed
   - Monitor KV storage usage

2. **Error Handling**
   - Implement retry logic for failed posts
   - Log errors for debugging
   - Provide user-friendly error messages

3. **Rate Limiting**
   - Respect Bluesky API rate limits (3s delay between posts)
   - Monitor function execution time
   - Use simulation mode for testing

4. **Cost Management**
   - Monitor function execution time
   - Clean up old sessions regularly
   - Use appropriate function memory limits

## üìñ Additional Resources

- [Vercel Documentation](https://vercel.com/docs)
- [Vercel KV](https://vercel.com/docs/storage/vercel-kv)
- [Vercel Functions](https://vercel.com/docs/functions)
- [Bluesky API](https://docs.bsky.app/)

---

*Like the murmuration of starlings, Flock Murmur creates beautiful patterns in the cloud.* üåä‚ú®
